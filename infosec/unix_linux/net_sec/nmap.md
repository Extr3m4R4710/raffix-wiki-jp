# Nmap
>セキュリティスキャナ。ポートスキャン機能の他、OSやサービスバージョンの検出、脆弱性検出機能など、多くの機能を兼ね備える。
>
>https://nmap.org

# 概要
Nmap(“Network Mapper”)はネットワーク探査やセキュリティ監査を目的としたツールでオープンソースとして開発されている。早い段階でTCP SYNスキャンをサポートし、その中で大規模ネットワークの迅速なスキャンを可能とするよう設計されている。また、Nmapは複雑な操作を行うオペレーターの要求に答えるため、パケットを巧みに操作する手法が数多く用意さており、その発展として高度なスキャニング機能を数多く揃えている。単純なポートスキャニングから、OSとサービスのバージョン判定、脆弱性スキャニングの他、指定したネットワーク範囲に存在する利用可能な機器のリスト化など、多機能なネットワーク検知を実現している。

Nmapはその特性上セキュリティ監査の他、攻撃者なども好んで使うが、多くのシステム管理者やネットワーク管理者からも日常のタスクを管理・監視する手立てとして使われている。

# Nmapの書式
```bash
nmap [スキャンタイプ] [オプション] [ターゲットの詳細]
```

## オプションの詳細
```bash
nmap [ホスト発見のオプション] [スキャンタイプのオプション] [ポート指定と順序のオプション] [サービスとバージョンの検出オプション] [OS検出のオプション] [タイミングやパフォーマンスのオプション] [ファイアウォール・IDSの回避とスプーフィングのオプション] [ターゲットの指定]
```

# Nmapに認識されるポート状態
簡単な従来型ポートスキャナは、ポートがopenかclosedのどちらかしか表示しないが、Nmapはかなり細やかな判定を可能としている。

ポートの状態は以下の6種類ある。

1. open
2. closed
3. filtered
4. unfiltered
5. open|filtered
6. closed|filtered

## open
`open`ポートは、TCPスキャンやUDPスキャンの結果、送信したパケットを受け付ける稼働中のポートを表す。

ポートスキャンの最大の目的はopenなポートを見つけることである。

## closed
`closed`状態のポートは、アクセス可能であるがlisten(待ち受け)しているサービス(アプリケーション)がない状態を指している。ここで言うアクセス可能とは、Nmapが生成するパケットの受信や応答ができるという意味である。closed状態のポートはlistenしているサービスがないだけで、後に起動される事もある。そのためターゲットを判断の材料やネットワーク図を書く際の有益な情報となる。closed状態のポートは、Pingスイープ、OSの検出などに役立つ場合がある。

管理者はlisten(待ち受け)しているサービスがないからといって放置するべきではない。余計なプロファイリングやリスクを避けるためにも、不要であればパケットフィルタリングを行い、`filtered`状態になるようにするべきである。

## filtered
`filtered`状態のポートは、開いているかどうか判別できないポートを指す。これはパケットフィルタリングでNmapが生成するパケットがポートまで到達していない状態がこれに分類される。パケットフィルタリングは、ルーターやファイアウォールのルール、ホストベースのファイアウォールソフトなどで行われている。

場合によって、宛先到達不能(タイプ3、コード13)のICMP応答を返す事があるが、一般的にICMP応答は返さずに、 スキャナーのパケットを破棄(DROP)場合多い。この場合Nmapは通信を破棄されたのはパケットフィルタリングではなくネットワークの混雑によるものと判断し、スキャンを複数回再実行するため、スキャン完了まのでの時間が長くなる(PBKDF2やArgon2で攻撃者が総当たり攻撃を試みる際に、そのマシンのリソースを大量に消費させ、攻撃を遅らせる作用と似ている)。

## unfiltered
`unfiltered`状態のポートは、アクセス可能だが、そのポートが開いているか閉じているかをNmapが判別できない事を意味する。unfiltered状態と判断できるのは、ファイアウォールのルールを解読するために使用されるACKキャンだけ。unfiltered状態のポートに対して、Windowsスキャン、SYNスキャン、、FINスキャンを行うことでポートが空いているかを判断することに役立てることができる。

## open|filtered
`open|filtered`状態はターゲットのポートが開いているのか、フィルタリングされているのか判別できない場合を指す。例えば、openポートから応答が返されないタイプのスキャンを実行した場合に、この状態が表示されることがある。ファイアウォールによって、送信中のパケットそのものが破棄されたか、応答途中で破棄された場合、Nmapはターゲットのポートがopenかfilteredを見分けることができない為、この状態を表示する。

UDPスキャン(-sU)、IPスキャン(nmap `target-IP`)、プロトコルスキャン(-sO)、FINスキャン(-sF)、Fullスキャン(nmap -p- -Aオプションなど)、Xmasスキャン(-sX)などが、応答を返さないタイプのスキャンに該当する。

## closed|filtered
`closed|filtered`状態はNmapがポートが閉じられているのか、フィルタリングされているのか判断できない時に示される。TCP Idle スキャン(-sI)で示されるそうだが、筆者はこの表示を確認した経験はない。

# ホストの発見オプション
ネットワーク偵察の第1段階はホストの有無を確かめる事なので、ポートスキャンの前にホストをホストの発見動作を行う。これによりアクセスできないターゲットへのポートスキャンを行うという無駄を省く。

Nmapはホストの発見オプションが何も指定されていない場合、「ポートの80番宛のTCP ACKパケット」と「ICMPエコー要求クエリ」をターゲットに送信する。ただし、LAN上のターゲットに対して、ARPスキャンを実行した場合は別。

### -sL
- リストスキャンを実行。
- 指定したホストが所属するネットワーク全てのホストを一覧表示する。
- ターゲットにパケットを送信せず、DNS逆引きのみで取得している。
- 他のオプションと併用できない。
```bash
[root@localhost~]# nmap -sL www.yandex.ru
Starting Nmap 7.95 ( https://nmap.org ) at 2025-04-07 20:03 JST
Nmap scan report for www.yandex.ru (77.88.44.55)
Other addresses for www.yandex.ru (not scanned): 77.88.55.88 5.255.255.77 2a02:6b8:a::a
rDNS record for 77.88.44.55: yandex.ru
Nmap done: 1 IP address (0 hosts up) scanned in 0.48 seconds
[root@localhost~]# nmap -sL yahoo.co.jp
Starting Nmap 7.95 ( https://nmap.org ) at 2025-04-07 20:05 JST
Nmap scan report for yahoo.co.jp (182.22.16.123)
Other addresses for yahoo.co.jp (not scanned): 182.22.16.251 182.22.24.124 182.22.24.252 182.22.25.124 182.22.25.252 182.22.28.252 182.22.31.124 182.22.31.252 183.79.219.124 183.79.219.252 183.79.249.124 183.79.249.252 183.79.250.251 124.83.184.124 124.83.184.252 124.83.185.124 124.83.185.252
Nmap done: 1 IP address (0 hosts up) scanned in 0.60 seconds
```

### -sn
- Pingスキャン。
- ホスト発見のみ実行し、アクティブなホストを一覧表示。
- デフォルトで、ICMPエコー要求と80番ポート宛てのTCPパケットを送信する。
    - 高い権限がないユーザが実行する場合は、SYNパケットが(connect()コールを使われる)ターゲットの80番ポートに送られる。
    - また権限の高いユーザーが実行した場合、イーサネット上のターゲットであればARP要求が使われる。
- ポートスキャンなどは行わず、軽量な調査に適している。
- ブロードキャストのクエリには応答しないホストが多い為、ブロードキャストアドレスにPingを行いよりも信頼性が高くなる
- 今(2025年)から11年前の書籍では-sPとして紹介されていた。
    - In previous releases of Nmap, -sn was known as -sP.
    -
    - 以前のNmapでは、-sn は -sP と呼ばれていました。
    - nmap.org - Host Discoveryより抜粋。

### -Pn
- Pingなし。
- 全てのターゲットのホストを稼働中(接続可能)と見なして、指定された全IPにスキャンを実行。
- ホストの発見処理はスキップされる。
- ファイアウォールで応答が制限されている場合に有効。

### -PS <ポートリスト>
- TCP SYN Pingスキャン。
- 指定ポートへSYNフラグがONのか空パケット(デフォルト: 80番)を送信する。
    - 例: -PS22,80,8080,8888
- 指定したポートが開いていれば、ターゲットはSYN/ACKを返す。
    - 閉じていればRSTを返してくる。
- Nmapを実行しているマシンはACKパケットを送って3ウェイハンドシェイクを完了すれば、コネクションを確立できるが、その代わりRSTパケットを送り、生成途中のコネクションをわざと切断する。
    - このRSTパケットはNmapが送る訳ではなく、Nmapを実行しているマシンのカーネルが送信する。理由はカーネルが予期しないSYN/ACKパケットを受信した為。
    - NmapはSYN/ACKパケットがRSTパケットのどちらかが返されたかで、ターゲットのポート番号が開いているかを判定しているが、TCP SYN Pingの目的はターゲットが稼働しているかである。
- Unix/Linuxの場合、rawソケットを使用する為には、root権限が必要。
    - こうした権限がないユーザーの場合、各ターゲットに対してconnect()システムコールを使用する。
    - これによりSYNパケットをターゲットに送信して、コネクションの確立を試みる。
    - connect()の戻り値として成功・失敗が得られた場合、Nmapはターゲットにアクセス可能と判断する。
- 戻り値はSYN/ACKかRSTのいずれか。
- コネクション未確立のままタイムアウトした場合はアクセス不能と判定される。

### -PA <ポートリスト>
- TCP ACK Pingスキャン。
- ACKパケットを送信し、RST応答でホストを検出。
- ステートレスファイアウォールの回避に有効。
- -PSに似ているが、SYNの代わりにACKを使用する。
- ACKパケットは確立された通信上のデータを承認する時に使わるが、TCP ACK Pingの実行時にはコネクションが存在しない。
    - そのため、これは異常値であるので、ターゲットは常にRSTパケットで接続を強制切断しなければならず、Nmapはターゲットへアクセスが可能であると判定する。
- -PSと同様にデフォルトポートは80番。
- Unixの場合、rootではないユーザーか、IPv6ターゲットが指定された場合は、connect()システムコールを利用する。
    - ただし、connect()システムコールはACKパケットではなくSYNパケットを送る為、厳密にはTCP SYN Pingになってしまう。

### -PU <ポートリスト>
- UDP Pingスキャン。
- 空のUDPパケットを送信する。
    - ただし、　--data-lengthが指定されいる場合はデータが詰まったUDPパケットを利用する。
- デフォルトポートは31,338番(UDP)。
- UDPパケットがターゲットの閉じたポートに到達すると、ICMP到達不能メッセージが返却される。
    - Nmapはこれにより、ターゲットがアクセス可能かを識別する。
        - 殆ど使われることのない31,338番(UDP)がデフォルトで使用される理由は、閉じたポートに到達しないと-PUで識別ができないからである。
    - 例えばLinksys社の無線ブロードバンドルーター(BEFW11S4)は、デフォルトで全てのTCPポートをフィルタ処理を行っているが、-PUをなどUDPパケットを使うと、ポート到達不能メッセージを返送するため、デバイスの正体に迫る事ができる。

### -PY <ポートリスト>、-PZ <ポートリスト>
- SCTPを利用するPingスキャン。
    - 2009年にSolaris 10(CVE-2009-2486)やLinux 2.6(CVE-2009-0065)にSCTPの脆弱性が見つかった事によりNmap 4.85 BATA10から追加。
        - SCTPについてはこちらを参照 -> https://e-words.jp/w/SCTP.html
        - SCTPはTCPやUDPと同じトランスポート層のプロトコル。
            - 電話のプロトコルであるSS7をIPに乗せる為設計された。
            - SCTPは`TCP + UDP + 発展`という性質を持っている。
            - 電話システムのアプリケーションがSCTPを使用している。
    - -PYはSCTP INIT Pingを実行する。
    - ターゲットに INITパケットを送信し、ターゲットのポートがopen状態ならINIT ACKを返し、closedならABORTパケットを返す。
        - INIT ACKとABORTを受け取ったNmapはアクセス可能と判定する。
    - -PZオプションはSCTP COOKIE-ECHO Pingを実行する。
    - ターゲットのポートがopenであれば何も返さない。
        - 一方でclosedならABORTパケットを返す。
    - ファイアウォールがSCPTパケットをフィルタリングしていない場合、このスキャンは有効。

### -PE、-PP、-PM
- ICMP Pingスキャンを実行。
    - pingコマンド等に用いられるプロトコル(ICMP)を使ったスキャン。
    - -PEはICMPエコー要求メッセージ(タイプ0)を送信する、
        - 利用可能ならホストからICMPをエコーを応答メッセージが返されなければ、Nmapはホストにアクセス可能と判定する。
            - セキュリティ上の理由によりRFCの要求通りに応答しないOSや装置もある。
                - 身近な例ではWindowsがある。
                - よって、インターネット上の未知のターゲットに対してICMPスキャンだけでは信頼性の高い結果を得られない。
    - -PPは、ICMPタイムスタンプメッセージ要求メッセージ(タイプ13)を送信する。
        - ターゲットからICMPタイムスタンプメッセージ応答メッセージ(タイプ14)が返されたならば、ホストにアクセス可能と判断される。
    - -PMは、ICMPアドレスマスクの要求メッセージ(タイプ17)を送信する。
        - ターゲットからICMPアドレスマスク応答(タイプ18)が返された場合、Nmapはホストはアクセス可能と判定する。
    - 管理者がICMPエコー要求パケットをブロックこそしているが、他のICMPクエリが同じ目的で用いられる可能性があることを見落としている場合に有効である。

### -PO <プロトコルリスト>
- このオプションはPingを実行しない。
-
